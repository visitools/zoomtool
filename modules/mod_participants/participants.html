<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <title>Participants</title>

    <!-- Include Icons -->
    <link rel="canonical" href="https://icons.getbootstrap.com/icons/camera-video/">
    <link rel="canonical" href="https://icons.getbootstrap.com/icons/app/">

    <!-- Include Bootstrap and jQuery -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <style>
        /* Status indicator styling */
        #status-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 9999;
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
        }

       
        /* Hide status indicator in fullscreen mode */
        *:fullscreen #status-indicator,
        *:-webkit-full-screen #status-indicator,
        *:-moz-full-screen #status-indicator,
        *:-ms-fullscreen #status-indicator {
            display: none;
        }
    </style>

    <script type="text/javascript">
    </script>
</head>
<body style="background: #212121;">

<!-- Connection Status Indicator -->
<div id="status-indicator" class="badge bg-secondary hidden" style="display: none;">Connecting...</div>

<!-- Include WebSocket communication module -->
<script src="/scripts/comms.js"></script>
<script>
const kShortName = "PARTICIPANTS";
const kModulePrefix = kShortName + ".";


    // Set up connection status callbacks
    onWebSocketConnected = function() {
        const indicator = document.getElementById('status-indicator');
        if (indicator) {
            indicator.textContent = 'Connected';
            indicator.className = 'badge bg-success';
        }
    };

    onWebSocketDisconnected = function() {
        const indicator = document.getElementById('status-indicator');
        if (indicator) {
            indicator.textContent = 'Disconnected';
            indicator.className = 'badge bg-danger';
        }
    };

    onWebSocketError = function(event) {
        const indicator = document.getElementById('status-indicator');
        if (indicator) {
            indicator.textContent = 'Error';
            indicator.className = 'badge bg-warning';
        }
    };

    function handleZTMessage(event) {
        let str = event.data;
        console.log("handleZTMessage:",str);

        let firstColonIndex = str.indexOf(':');
        let secondColonIndex = str.indexOf(':', firstColonIndex + 1);

        let parts = [];
        if (firstColonIndex !== -1) {
            parts.push(str.substring(0, firstColonIndex));

            if (secondColonIndex !== -1) {
                parts.push(str.substring(firstColonIndex + 1, secondColonIndex));
                parts.push(str.substring(secondColonIndex + 1));
            } else {
                parts.push(str.substring(firstColonIndex + 1));
            }
        } else {
            parts.push(str);
        }
        if (LogLevel >= LL_All) console.log(parts);

        if (parts.length<1) return;

        const cmd = parts[0];

        if (cmd.startsWith("CONNECTED")) refreshList();
       // if (cmd == "ClearLists") clearLists();

        if (parts.length > 0) {
            if (cmd.startsWith(kModulePrefix)) handleParticipantData(str.substring(kModulePrefix.length + 1));
        }
    }

    function handleParticipantData(data) {
        const parts = data.split(',');
        const onlineCount = parts[0];
        const onlineState = parts[1];
        const userID = parts[2];
        const userRole = parts[3];
        const videoState = parts[4];
        const audioState = parts[5];
        const handState = parts[6];

        // Handle userName containing commas
        // Split by comma, but join from the 8th element onwards for userName
        const split = data.split(',');
        const userNameIndex = 7;
        let userName = "";
        if (split.length > userNameIndex) {
            userName = split.slice(userNameIndex).join(',');
        }

        console.log("Params:",parts);
        console.log("OnlineCount:",onlineCount);
        setBigNumber(onlineCount);

    }

    function escapeHtml(text) {
        var map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };

        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    function getOrCreateElement(UserID, UserName, prefix=zidPrefix) {
        const existingElement = document.getElementById(prefix+UserID);

        if (existingElement != null) return existingElement;

        let newElement = document.createElement("div");
        newElement.id = zidPrefix+UserID;
        newElement.innerHTML = "<q></q> "+escapeHtml(UserName);
        newElement.classList.add("userContainer");
        newElement.classList.add("CamOn");
        newElement.setAttribute('sorttext', UserName);
        newElement.setAttribute('ustate', "Y");
        return newElement;
    }


    function createHiddenElement(UserID, UserName) {
        let newElement = document.createElement("div");
        newElement.classList.add("userContainer");
        newElement.id = hidPrefix+UserID;
        newElement.innerText = UserName;
        newElement.setAttribute('sorttext', UserName);
        newElement.setAttribute('ustate', "X");
        newElement.classList.add('flagfade');
        return newElement;
    }

    function refreshList() {
        //clearLists();
        sendToServer("PARTICIPANTS.REFRESH");
    }

</script>


<div id="big-number-container"
     style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 80vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #212121;
        margin: 0;
        z-index: 1000;
     ">
<div id="big-title"
style="
   font-size: 10vw;
   font-weight: bold;
   color: #eeeeee;
   margin-bottom: 0px;
   text-shadow: 0 2px 4px #111;
   letter-spacing: 0.04em;
">
Participants
</div>
    <div id="big-number-display"
         style="
            font-size: 32vw;
            font-weight: bold;
            line-height: 1;
            color: #5f5f5f;
         ">
        &nbsp;
    </div>
</div>
<script>
    // Dynamically set the number
    function setBigNumber(n) {
        if (n >= 0) {
            document.getElementById('big-number-display').textContent = n;
        } else {
            document.getElementById('big-number-display').textContent = "N/A";
        }
    }
</script>


<br>
<script>
    // Utility to toggle fullscreen mode
    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            // Enter fullscreen
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen();
            } else if (document.documentElement.webkitRequestFullscreen) { // Safari
                document.documentElement.webkitRequestFullscreen();
            } else if (document.documentElement.msRequestFullscreen) { // IE11
                document.documentElement.msRequestFullscreen();
            }
        } else {
            // Exit fullscreen
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) { // Safari
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) { // IE11
                document.msExitFullscreen();
            }
        }
    }

    window.addEventListener('keydown', function(e) {
        // Only listen for unmodified spacebar (not in an input/textarea/etc)
        if (e.code === 'Space' && !(e.ctrlKey || e.altKey || e.metaKey) && 
            ['INPUT','TEXTAREA'].indexOf(document.activeElement.tagName) === -1) {
            e.preventDefault();
            toggleFullscreen();
        }
    });
</script>


</body>
</html>
