<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <title>Participants</title>

    <!-- Include Icons -->
    <link rel="canonical" href="https://icons.getbootstrap.com/icons/camera-video/">
    <link rel="canonical" href="https://icons.getbootstrap.com/icons/app/">

    <!-- Include Bootstrap and jQuery -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <script type="text/javascript">
    </script>
</head>
<body style="background: #212121;">
<script>
    const LL_None = 0;
    const LL_Sparse = 1;
    const LL_Info = 6;
    const LL_All = 9;

    let LogLevel = LL_Sparse;
    const LL_Dev = LogLevel + 1;

    let isConnected = false;


    let ShouldConnect = true;
    let socket = null;

    function connectWebSocket() {
        if (ShouldConnect != true) return;

        // Determine WebSocket URL based on current location
        var wsProtocol = (window.location.protocol === 'https:') ? 'wss://' : 'ws://';
        var wsURL = wsProtocol + window.location.host + '/'; // Use appropriate path

        // Create a new WebSocket
        socket = new WebSocket(wsURL);

        // Connection opened
        socket.addEventListener('open', function (event) {
            isConnected = true;
            if (LogLevel >= LL_Sparse) console.log('Connected to WebSocket');
            // You can now send messages using socket.send('Your Message');
        });

        // Listen for messages
        socket.addEventListener('message', function (event) {
            if (LogLevel >= LL_Dev) console.log('Message from server:', event.data);
            handleMessage(event);
        });

        // Handle any errors that occur.
        socket.addEventListener('error', function (event) {
            if (LogLevel >= LL_Sparse) console.error('WebSocket Error:');
            isConnected = false;
            socket.close(); // Ensure WebSocket is closed before trying to reconnect
        });

        // Listen for possible close
        socket.addEventListener('close', function (event) {
            if (LogLevel >= LL_Sparse) console.log('WebSocket connection closed:');
            isConnected = false;
            reconnectWebSocket();
        });
    }

    let reconnectInterval = 1000; // Start with 1 second
    const maxInterval = 30000; // Maximum interval of 30 seconds

    function reconnectWebSocket() {
        setTimeout(() => {
            if (LogLevel >= LL_Sparse) console.log("Attempting to reconnect...");
            connectWebSocket();
            // Increase the interval for next reconnection attempt
            reconnectInterval = Math.min(maxInterval, reconnectInterval * 2);
        }, reconnectInterval);
    }



    function sendToServer(message) {
        if (isConnected) {
            socket.send(message);
            return true;
        } else {
            return false;
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        connectWebSocket();
    });

    window.addEventListener("beforeunload", () => {
        ShouldConnect = false;
        if (socket != null) {
            socket.close();
        }
    });



    function handleMessage(event) {
        let str = event.data;
        console.log("handleMessage:",str);

        let firstColonIndex = str.indexOf(':');
        let secondColonIndex = str.indexOf(':', firstColonIndex + 1);

        let parts = [];
        if (firstColonIndex !== -1) {
            parts.push(str.substring(0, firstColonIndex));

            if (secondColonIndex !== -1) {
                parts.push(str.substring(firstColonIndex + 1, secondColonIndex));
                parts.push(str.substring(secondColonIndex + 1));
            } else {
                parts.push(str.substring(firstColonIndex + 1));
            }
        } else {
            parts.push(str);
        }
        if (LogLevel >= LL_All) console.log(parts);

        if (parts.length<1) return;

        const cmd = parts[0];

        if (cmd.startsWith("CONNECTED")) refreshList();
       // if (cmd == "ClearLists") clearLists();

        if (parts.length > 0) {
            if (cmd.startsWith('part')) handleParticipantData(str.substring(5));
        }
    }

    function handleParticipantData(data) {
        const parts = data.split(',');
        const onlineCount = parts[0];
        const onlineState = parts[1];
        const userID = parts[2];
        const userRole = parts[3];
        const videoState = parts[4];
        const audioState = parts[5];
        const handState = parts[6];

        // Handle userName containing commas
        // Split by comma, but join from the 8th element onwards for userName
        const split = data.split(',');
        const userNameIndex = 7;
        let userName = "";
        if (split.length > userNameIndex) {
            userName = split.slice(userNameIndex).join(',');
        }

        console.log("Params:",parts);
        console.log("OnlineCount:",onlineCount);
        setBigNumber(onlineCount);

    }

    function escapeHtml(text) {
        var map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };

        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    function getOrCreateElement(UserID, UserName, prefix=zidPrefix) {
        const existingElement = document.getElementById(prefix+UserID);

        if (existingElement != null) return existingElement;

        let newElement = document.createElement("div");
        newElement.id = zidPrefix+UserID;
        newElement.innerHTML = "<q></q> "+escapeHtml(UserName);
        newElement.classList.add("userContainer");
        newElement.classList.add("CamOn");
        newElement.setAttribute('sorttext', UserName);
        newElement.setAttribute('ustate', "Y");
        return newElement;
    }


    function createHiddenElement(UserID, UserName) {
        let newElement = document.createElement("div");
        newElement.classList.add("userContainer");
        newElement.id = hidPrefix+UserID;
        newElement.innerText = UserName;
        newElement.setAttribute('sorttext', UserName);
        newElement.setAttribute('ustate', "X");
        newElement.classList.add('flagfade');
        return newElement;
    }

    function refreshList() {
        //clearLists();
        socket.send("PARTICIPANTS.REFRESH");
    }

</script>


<div id="big-number-container"
     style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 80vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #212121;
        margin: 0;
        z-index: 1000;
     ">
<div id="big-title"
style="
   font-size: 10vw;
   font-weight: bold;
   color: #eeeeee;
   margin-bottom: 0px;
   text-shadow: 0 2px 4px #111;
   letter-spacing: 0.04em;
">
Participants
</div>
    <div id="big-number-display"
         style="
            font-size: 32vw;
            font-weight: bold;
            line-height: 1;
            color: #5f5f5f;
         ">
        N/A
    </div>
</div>
<script>
    // Dynamically set the number
    function setBigNumber(n) {
        if (n >= 0) {
            document.getElementById('big-number-display').textContent = n;
        } else {
            document.getElementById('big-number-display').textContent = "N/A";
        }
    }
</script>


<br>
<script>
    // Utility to toggle fullscreen mode
    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            // Enter fullscreen
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen();
            } else if (document.documentElement.webkitRequestFullscreen) { // Safari
                document.documentElement.webkitRequestFullscreen();
            } else if (document.documentElement.msRequestFullscreen) { // IE11
                document.documentElement.msRequestFullscreen();
            }
        } else {
            // Exit fullscreen
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) { // Safari
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) { // IE11
                document.msExitFullscreen();
            }
        }
    }

    window.addEventListener('keydown', function(e) {
        // Only listen for unmodified spacebar (not in an input/textarea/etc)
        if (e.code === 'Space' && !(e.ctrlKey || e.altKey || e.metaKey) && 
            ['INPUT','TEXTAREA'].indexOf(document.activeElement.tagName) === -1) {
            e.preventDefault();
            toggleFullscreen();
        }
    });
</script>


</body>
</html>
